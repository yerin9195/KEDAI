<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">

	<select id="dept_select" resultType="com.spring.app.domain.DeptVO">
		select dept_code, dept_name
		from tbl_dept
		order by dept_code asc
	</select>
	
	<select id="job_select" resultType="com.spring.app.domain.JobVO">
		select job_code, job_name
		from tbl_job
		order by job_code asc
	</select>
		<select id="idDuplicateCheck" resultType="String">
		select empid
		from tbl_employees
		where empid = #{empid}
	</select>
	
	<select id="emailDuplicateCheck" resultType="String">
		select email
		from tbl_employees
		where email = #{email}
	</select>
	
	<insert id="empRegister" parameterType="MemberVO">
		insert into tbl_employees(empid, pwd, name, nickname, jubun, email, mobile, postcode, address, detailaddress, extraaddress, imgfilename, orgimgfilename, hire_date, salary, commission_pct, fk_dept_code, fk_job_code, dept_tel)
		<choose>
			<when test="(fk_dept_code == null and dept_tel == null) and fk_job_code == null">
    			values(#{empid}, #{pwd}, #{name}, #{nickname}, #{jubun}, #{email}, #{mobile}, #{postcode}, #{address}, #{detailaddress}, #{extraaddress}, #{imgfilename}, #{orgimgfilename}, to_date(#{hire_date}, 'yyyy-mm-dd'), to_number(#{salary}), 0, null, null, null)
	    	</when>
	    	<when test="(fk_dept_code == null and dept_tel == null) and fk_job_code != null">
    			values(#{empid}, #{pwd}, #{name}, #{nickname}, #{jubun}, #{email}, #{mobile}, #{postcode}, #{address}, #{detailaddress}, #{extraaddress}, #{imgfilename}, #{orgimgfilename}, to_date(#{hire_date}, 'yyyy-mm-dd'), to_number(#{salary}), 0, null, #{fk_job_code}, null)
	    	</when>
	    	<when test="(fk_dept_code != null and dept_tel != null) and fk_job_code == null">
    			values(#{empid}, #{pwd}, #{name}, #{nickname}, #{jubun}, #{email}, #{mobile}, #{postcode}, #{address}, #{detailaddress}, #{extraaddress}, #{imgfilename}, #{orgimgfilename}, to_date(#{hire_date}, 'yyyy-mm-dd'), to_number(#{salary}), 0, #{fk_dept_code}, null, #{dept_tel})
	    	</when>
	    	<when test="(fk_dept_code != null and dept_tel != null) and fk_job_code != null">
    			values(#{empid}, #{pwd}, #{name}, #{nickname}, #{jubun}, #{email}, #{mobile}, #{postcode}, #{address}, #{detailaddress}, #{extraaddress}, #{imgfilename}, #{orgimgfilename}, to_date(#{hire_date}, 'yyyy-mm-dd'), to_number(#{salary}), 0, #{fk_dept_code}, #{fk_job_code}, #{dept_tel})
	    	</when>
		</choose>
	</insert>
	
	<insert id="insert_accessTime" parameterType="HashMap">
		insert into tbl_empManager_accessTime(accessTime_seq, pageUrl, fk_empid, clientIP, accessTime)
		values(empManager_accessTime_seq.nextval, #{pageUrl}, #{fk_empid}, #{clientIP}, #{accessTime})
	</insert>
	
  	<resultMap type="HashMap" id="pageurlEmpname_Map">
    	<result property="pagename"   column="PAGENAME"   javaType="String" />
       	<result property="name"       column="NAME"       javaType="String" />
       	<result property="cnt"        column="CNT"        javaType="String" />
   	</resultMap>
	
	<select id="pageurlEmpname" resultMap="pageurlEmpname_Map">
		SELECT case 
		       when instr(PAGEURL, '/KEDAI/approval/main.kedai', 1, 1) > 0 then '전자결재' 
		       when instr(PAGEURL, '/KEDAI/pay_stub.kedai', 1, 1) > 0 then '급여명세서'
		       when instr(PAGEURL, '/KEDAI/roomResercation.kedai', 1, 1) > 0 then '회의실예약'
		       when instr(PAGEURL, '/KEDAI/board/list.kedai', 1, 1) > 0 then '게시판'
		       when instr(PAGEURL, '/KEDAI/community/list.kedai', 1, 1) > 0 then '커뮤니티'
		       when instr(PAGEURL, '/KEDAI/carShare.kedai', 1, 1) > 0 then '카쉐어'
		       when instr(PAGEURL, '/KEDAI/bus.kedai', 1, 1) > 0 then '통근버스'
		       when instr(PAGEURL, '/KEDAI/employee.kedai', 1, 1) > 0 then '사내연락망'
		       when instr(PAGEURL, '/KEDAI/othercom_list.kedai', 1, 1) > 0 then '거래처정보'
		       else '기타'
		       end AS PAGENAME
		     , name     
		     , CNT
		FROM 
		(
		    SELECT E.name, A.pageurl, A.cnt 
		    FROM 
		    (
		        select NVL(substr(pageurl, 1, instr(pageurl, '?', 1, 1)-1), pageurl) AS PAGEURL 
		             , fk_empid
		             , count(*) AS CNT 
		        from tbl_empManager_accessTime
		        group by NVL(substr(pageurl, 1, instr(pageurl, '?', 1, 1)-1), pageurl), fk_empid
		    ) A JOIN tbl_employees E
		    ON A.fk_empid = E.empid
		) V
		ORDER BY 1, 2
	</select>

</mapper>