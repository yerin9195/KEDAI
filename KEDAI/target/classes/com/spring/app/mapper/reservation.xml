<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="reservation">
	<resultMap id="stationList" type="BusVO">
	    <result property="bus_no" column="bus_no" javaType="String"/>
	    <result property="pf_station_id" column="pf_station_id"	javaType="String"/>
	    <result property="pk_station_id" column="pk_station_id"	javaType="String"/>
	    <result property="first_time" column="first_time"	javaType="String"/>
	    <result property="last_time" column="last_time"	javaType="String"/>
	    <result property="station_name" column="station_name"	javaType="String"/>
	    <result property="time_gap" column="time_gap"	javaType="int"/>
	</resultMap>
	<select id="getStationList" parameterType="String" resultMap="stationList">		
		select bus_no, v.pf_station_id, h.pk_station_id, first_time, last_time, h.station_name, time_gap, lat, lng, way, zindex
		from 
		(
		select bus_no, pf_station_id, first_time, last_time, time_gap
		from tbl_bus
		where bus_no = #{bus_no}
		order by first_time asc
		)v cross join
		(
		select pk_station_id, station_name, lat, lng, way, zindex
		from tbl_station
		)h
		where h.pk_station_id = v.pf_station_id
		order by v.first_time asc
	</select>
	
	<resultMap id="stationTime" type="BusVO">
       <result property="bus_no"                   column="bus_no"                   javaType="String"/>
       <result property="pf_station_id"            column="pf_station_id"            javaType="String"/>
       <result property="station_name"             column="station_name"             javaType="String"/>
       <result property="way"                      column="way"                      javaType="String"/>
       <result property="zindex"                   column="zindex"             		 javaType="int"/>
       <result property="minutes_until_next_bus"   column="minutes_until_next_bus"   javaType="int"/>
   </resultMap>
   <select id="getStationTimeList" parameterType="HashMap" resultMap="stationTime">      
     WITH current_times
      AS (
            select bus_no, v.pf_station_id, h.pk_station_id, first_time, last_time, h.station_name, time_gap, lat, lng, way, current_time, zindex
              from 
              (
                  select bus_no, pf_station_id, TO_DATE(first_time, 'HH24:MI') AS first_time
                       , TO_DATE(last_time, 'HH24:MI') AS last_time, time_gap
                       , TO_DATE(TO_CHAR(SYSDATE, 'HH24:MI'), 'HH24:MI') AS current_time
                  from tbl_bus
                  where bus_no = #{bus_no}
                  order by first_time asc
              )v cross join
              (
                  select pk_station_id, station_name, lat, lng, way, zindex
                  from tbl_station
                  where pk_station_id=#{pf_station_id}
              )h
              where h.pk_station_id = v.pf_station_id
              order by v.first_time asc
          )
      SELECT
          bus_no, pf_station_id, station_name, way, lat, lng, zindex,
          CASE
          <![CDATA[
              WHEN current_time < first_time THEN
              ]]>
                  ROUND((first_time - current_time) * 24 * 60)
            <![CDATA[
              WHEN current_time > last_time THEN
               ]]>
                  NULL
              ELSE
                  ROUND(
                      (time_gap - MOD(
                          (current_time - first_time) * 24 * 60,
                          time_gap
                      ))
                  )
          END AS minutes_until_next_bus
      FROM
          current_times
   </select>
	
	<select id="getmyCar" resultType="CarVO" parameterType="String">
		select car_seq, fk_empid, car_num, car_type, max_num, insurance, drive_year, license, car_imgfilename, car_orgimgfilename
		from tbl_car
		where fk_empid = #{fk_empid}
	</select>	
	
	<select id="getmyCar2" resultType="CarVO" parameterType="String">
		select car_seq, fk_empid, car_num, car_type, max_num, insurance, drive_year, license, car_imgfilename, car_orgimgfilename
		from tbl_car
		where fk_empid = #{fk_empid}
	</select>	

	<insert id="addMyCar" parameterType="HashMap">
		insert into tbl_car(car_seq, fk_empid, car_num, car_type, max_num, insurance, drive_year, license, car_imgfilename, car_orgimgfilename)
		values(car_seq.nextval, #{fk_empid}, #{car_num}, #{car_type}, #{max_num}, #{insurance}, #{drive_year}, #{license}, #{car_imgfilename}, #{car_orgimgfilename})
	</insert>
	
	<update id="editMycar" parameterType="HashMap">
		update tbl_car set car_num = #{car_num}
		<choose>
						 <when test='car_orgimgfilename != ""'>
						 , car_orgimgfilename = #{car_orgimgfilename}
						 </when>
						 <when test='car_orgimgfilename == ""'></when>
						 <when test="'car_imgfilenname == null"></when>
						 <when test="car_imgfilename != null">
		                 , car_imgfilename = #{car_imgfilename}
		                 </when>
	    </choose>
		                 , car_type = #{car_type}
		                 , max_num = #{max_num}
		                 , drive_year = #{drive_year}
		where fk_empid = #{fk_empid}
	</update>
	
	<insert id="addcarRegister" parameterType="HashMap">
		insert into tbl_day_share(res_num, fk_car_seq, start_date, last_date, dp_name, dp_add, dp_lat, dp_lng, start_time, ds_name, ds_add, ds_lat, ds_lng, want_max, end_status, cancel_status)
		values(res_num.nextval, #{car_seq}, #{start}, #{last}, #{departure_name}, #{departure_address}, #{dp_lat}, #{dp_lng}, #{startTime}, #{arrive_name}, #{arrive_address}, #{ds_lat}, #{ds_lng}, #{fk_cnum}, default, default)
	
	</insert>
	
	<resultMap id="carShareList" type="HashMap">
		<result property="res_num" column="res_num" javaType="int"/>
	    <result property="start_date" column="start_date" javaType="String"/>
	    <result property="last_date" column="last_date"	javaType="String"/>
	    <result property="dp_name" column="dp_name"	javaType="String"/>
	    <result property="ds_name" column="ds_name"	javaType="String"/>
	    <result property="want_max" column="want_max"	javaType="int"/>
	    <result property="end_status" column="end_status"	javaType="int"/>
	    <result property="cancel_status" column="cancel_status"	javaType="int"/>
	    <result property="start_time" column="start_time"	javaType="String"/>
	    <result property="nickname" column="nickname"	javaType="String"/>
	</resultMap>
	<select id="getcarShareList" resultMap="carShareList">
		select res_num, start_date, last_date, dp_name, ds_name, want_max, end_status, cancel_status, start_time, nickname
		from 
		(
		select res_num, start_date, last_date, dp_name, ds_name, want_max, end_status, cancel_status, start_time, fk_car_seq
		from tbl_day_share
		where end_status = 1 and cancel_status = 1
		)a cross join
		(
		    select car_seq, fk_empid, car_num, car_type, max_num, nickname
		    from 
		    (
		        select *
		        from tbl_car
		    ) v cross join
		    (
		        select *
		        from tbl_employees
		    ) h
		    where fk_empid = h.empid
		)b
		where fk_car_seq = b.car_seq
	</select>
	
	<resultMap id="dayShareDetail" type="Day_shareVO">
		<result property="res_num" column="res_num" javaType="int"/>
	    <result property="fk_car_seq" column="fk_car_seq"	javaType="int"/>
	    <result property="start_date" column="start_date" javaType="String"/>
	    <result property="last_date" column="last_date"	javaType="String"/>
	    <result property="dp_name" column="dp_name"	javaType="String"/>
	    <result property="dp_add" column="dp_add"	javaType="String"/>
	    <result property="dp_lat" column="dp_lat"	javaType="double"/>
	    <result property="dp_lng" column="dp_lng"	javaType="double"/>
	    <result property="ds_name" column="ds_name"	javaType="String"/>
	    <result property="ds_add" column="ds_add"	javaType="String"/>
	    <result property="ds_lat" column="ds_lat"	javaType="double"/>
	    <result property="ds_lng" column="ds_lng"	javaType="double"/>
	    <result property="want_max" column="want_max"	javaType="int"/>
	    <result property="end_status" column="end_status"	javaType="int"/>
	    <result property="cancel_status" column="cancel_status"	javaType="int"/>
	    <result property="start_time" column="start_time"	javaType="String"/>
	</resultMap>
	<select id="getday_shareInfo" resultMap="dayShareDetail">
		select res_num, fk_car_seq, start_date,last_date,dp_name,dp_add,dp_lat, dp_lng, ds_name, ds_add, ds_lat, ds_lng, want_max, end_status, cancel_status, start_time
		from tbl_day_share
		where res_num = #{res_num}
	</select>
	
	
	<insert id="addcarApply_detail" parameterType="HashMap">
		insert into tbl_car_share(pf_res_num, pf_empid, share_date, share_may_time, accept_yon, rdp_name, rdp_add, rdp_lat, rdp_lng, rds_name, rds_add, rds_lat, rds_lng)
		values(#{pf_res_num}, #{pf_empid}, #{share_date}, #{share_may_time}, default, #{rdp_name}, #{rdp_add}, #{rdp_lat}, #{rdp_lng}, #{rds_name}, #{rds_add}, #{rds_lat}, #{rds_lng})
	
	</insert>
</mapper>